<!DOCTYPE html>
<html>

<head>
    <style>
        html {
            height: 100%;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            color: #fff;
            font-family: -apple-system, "SF Mono", "Monaco", monospace;
            padding: 12px 16px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* ROW 1: Branding + Toggle */
        .row-1 {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .branding {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .app-icon {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .app-name {
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.5px;
            color: #888;
        }

        .pill-toggle {
            background: transparent;
            border: 1px solid #333;
            color: #666;
            font-size: 9px;
            font-weight: 600;
            padding: 6px 16px;
            cursor: pointer;
            border-radius: 16px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 200ms ease-in-out;
            font-family: inherit;
            outline: none;
        }

        .pill-toggle:hover {
            border-color: #555;
            color: #888;
            outline: none;
        }

        .pill-toggle.active {
            background: #fff;
            color: #000;
            border-color: #fff;
            outline: none;
        }

        /* ROW 2: Settings + Quit */
        .row-2 {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
        }

        .row-2 a {
            color: #444;
            font-size: 9px;
            text-decoration: none;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            transition: color 150ms ease-in-out;
            outline: none;
        }

        .row-2 a:hover {
            color: #888;
        }

        /* SETTINGS VIEW */
        #settings-view {
            display: none;
            flex-direction: column;
            gap: 16px;
            opacity: 0;
            transition: opacity 200ms ease-in-out;
        }

        #settings-view.visible {
            display: flex;
            opacity: 1;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 12px;
            border-bottom: 1px solid #111;
        }

        .settings-title {
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.5px;
            color: #888;
        }

        .back-link {
            color: #444;
            font-size: 9px;
            text-decoration: none;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            transition: color 150ms ease-in-out;
            outline: none;
        }

        .back-link:hover {
            color: #888;
        }

        .settings-content {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        input {
            background: transparent;
            border: none;
            border-bottom: 1px solid #222;
            color: #fff;
            padding: 8px 0;
            width: 100%;
            font-size: 10px;
            outline: none;
            font-family: inherit;
            transition: border-color 150ms ease-in-out;
        }

        input::placeholder {
            color: #333;
        }

        input:focus {
            border-bottom-color: #444;
        }

        .save-btn {
            width: 100%;
            background: #fff;
            color: #000;
            border: none;
            padding: 10px;
            font-size: 9px;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-family: inherit;
            transition: all 150ms ease-in-out;
            margin-top: 8px;
            border-radius: 16px;
        }

        .save-btn:hover {
            background: #ddd;
        }

        .toggle-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }

        .toggle-row span {
            font-size: 10px;
            color: #888;
        }

        .switch {
            position: relative;
            width: 36px;
            height: 20px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #333;
            transition: 0.2s;
            border-radius: 20px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: #666;
            transition: 0.2s;
            border-radius: 50%;
        }

        .switch input:checked + .slider {
            background-color: #fff;
        }

        .switch input:checked + .slider:before {
            transform: translateX(16px);
            background-color: #000;
        }

        /* MODAL */
        #modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 16px;
            z-index: 100;
        }

        .modal-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        #modal .modal-text {
            font-size: 9px;
            color: #888;
            letter-spacing: 0.5px;
        }

        #modal button {
            background: #fff;
            color: #000;
            border: none;
            padding: 6px 16px;
            font-size: 9px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 16px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-family: inherit;
            outline: none;
            transition: all 150ms ease-in-out;
        }
    </style>
</head>

<body>
    <!-- MAIN VIEW -->
    <div id="main-view" style="display: flex; flex-direction: column; justify-content: space-between; height: 100%;">
        <div class="row-1">
            <div class="branding">
                <div class="app-icon">â—†</div>
                <span class="app-name">POCKET</span>
            </div>
            <button id="power-btn" class="pill-toggle" onclick="toggle()">START</button>
        </div>

        <div class="row-2">
            <a href="#" onclick="window.electronAPI.send('QUIT'); return false;">Quit</a>
            <a href="#" onclick="showSettings(); return false;">Settings</a>
        </div>
    </div>

    <!-- SETTINGS VIEW -->
    <div id="settings-view">
        <div class="settings-header">
            <span class="settings-title">SETTINGS</span>
            <a href="#" class="back-link" onclick="hideSettings(); return false;">Back</a>
        </div>
        <div class="settings-content">
            <input type="password" id="cf-token" placeholder="Cloudflare Token">
            <input type="text" id="cf-domain" placeholder="Custom Domain">
            <div class="toggle-row">
                <span>Debug Logging</span>
                <label class="switch">
                    <input type="checkbox" id="debug-logging">
                    <span class="slider"></span>
                </label>
            </div>
            <button onclick="saveSettings()" class="save-btn">Save Changes</button>
        </div>
    </div>


    <div id="modal">
        <div class="modal-content">
            <span class="modal-text" id="kid-display"></span>
            <button onclick="approve()">ALLOW</button>
        </div>
    </div>

    <script>
        // Use secure electronAPI from preload script (no direct Node access)
        const api = window.electronAPI;

        let active = false;
        let currentUrl = "";
        const btn = document.getElementById('power-btn');
        const modal = document.getElementById('modal');
        const kidDisplay = document.getElementById('kid-display');
        let pendingAuth = null;

        // Load settings - token from secure storage, domain from regular store
        async function loadSettings() {
            const [token, settings] = await Promise.all([
                api.invoke('GET_SECURE_TOKEN'),
                api.invoke('GET_STORE', 'cfSettings')
            ]);
            document.getElementById('cf-token').value = token || '';
            document.getElementById('cf-domain').value = (settings && settings.domain) || '';
            document.getElementById('debug-logging').checked = (settings && settings.debugLogging) || false;
        }
        loadSettings();

        async function showSettings() {
            document.getElementById('main-view').style.display = 'none';
            const settingsView = document.getElementById('settings-view');

            // Expand window
            await api.invoke('RESIZE_WINDOW', 240);

            // Show settings with fade
            settingsView.classList.add('visible');
        }

        async function hideSettings() {
            const settingsView = document.getElementById('settings-view');
            const mainView = document.getElementById('main-view');

            // Fade out
            settingsView.classList.remove('visible');

            // Wait for fade, then collapse window
            setTimeout(async () => {
                settingsView.style.display = 'none';
                mainView.style.display = 'flex';
                await api.invoke('RESIZE_WINDOW', 80);
            }, 200);
        }

        async function saveSettings() {
            const token = document.getElementById('cf-token').value;
            const domain = document.getElementById('cf-domain').value;
            const debugLogging = document.getElementById('debug-logging').checked;

            // Store token securely in OS keychain
            await api.invoke('SET_SECURE_TOKEN', token);

            // Store non-sensitive settings in regular store
            await api.invoke('SET_STORE', 'cfSettings', { domain, debugLogging });

            hideSettings();
        }

        async function toggle() {
            if (!active) {
                btn.innerText = "...";

                // Get token from secure storage, domain from regular store
                const [token, settings] = await Promise.all([
                    api.invoke('GET_SECURE_TOKEN'),
                    api.invoke('GET_STORE', 'cfSettings')
                ]);

                const cfSettings = {
                    token: token || '',
                    domain: (settings && settings.domain) || ''
                };

                api.invoke('START', cfSettings).then(async res => {
                    if (res.success) {
                        active = true;
                        btn.classList.add('active');
                        btn.innerText = "STOP";

                        // Update tray icon to active state
                        await api.invoke('SET_TRAY_ICON', true);
                    }
                });
            } else {
                await api.invoke('STOP');
                active = false;
                btn.classList.remove('active');
                btn.innerText = "START";

                // Update tray icon to idle state
                await api.invoke('SET_TRAY_ICON', false);
            }
        }

        api.on('TUNNEL_LIVE', (url) => {
            currentUrl = url;
            // URL is now displayed elsewhere
        });

        api.on('AUTH_FAILED', (data) => {
            pendingAuth = data;
            kidDisplay.innerText = "New device: " + data.kid.substring(0, 12) + "...";
            modal.style.display = 'flex';
        });

        function approve() {
            if (pendingAuth) {
                api.invoke('REGISTER_KEY', { kid: pendingAuth.kid, jwk: pendingAuth.jwk }).then(() => {
                    modal.style.display = 'none';
                    pendingAuth = null;
                });
            }
        }
    </script>
</body>

</html>