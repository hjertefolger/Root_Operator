<!DOCTYPE html>
<html>

<head>
    <style>
        html {
            height: 100%;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            color: #fff;
            font-family: -apple-system, "SF Mono", "Monaco", monospace;
            padding: 12px 16px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* ROW 1: Branding + Toggle */
        .row-1 {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .branding {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .app-icon {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .app-name {
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.5px;
            color: #888;
        }

        .pill-toggle {
            background: transparent;
            border: 1px solid #333;
            color: #666;
            font-size: 9px;
            font-weight: 600;
            padding: 6px 16px;
            cursor: pointer;
            border-radius: 16px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 200ms ease-in-out;
            font-family: inherit;
            outline: none;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .pill-toggle:hover {
            border-color: #555;
            color: #888;
            outline: none;
        }

        .pill-toggle.active {
            background: #fff;
            color: #000;
            border-color: #fff;
            outline: none;
        }

        .pill-toggle.connecting {
            border-color: #555;
            color: #888;
            cursor: wait;
        }

        .pill-toggle .icon {
            width: 12px;
            height: 12px;
        }

        .pill-toggle .icon svg {
            width: 100%;
            height: 100%;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .pill-toggle .icon.spinning svg {
            animation: spin 1s linear infinite;
        }

        /* Status icons row */
        .status-icons {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-icons .icon-btn {
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 150ms ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 14px;
        }

        .status-icons .icon-btn:hover {
            opacity: 1;
        }

        .status-icons .icon-btn.muted {
            cursor: default;
        }

        .status-icons .icon-btn svg {
            width: 14px;
            height: 14px;
            stroke: #fff;
            transition: stroke 150ms ease-in-out;
        }

        .status-icons .icon-btn:hover svg {
            stroke: #007AFF;
        }

        .status-icons .icon-btn.muted svg {
            stroke: #444;
        }

        .status-icons .icon-btn.muted:hover svg {
            stroke: #444;
        }

        /* ROW 2: Settings + Quit */
        .row-2 {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
            min-height: 22px;
        }

        .row-2-left {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .row-2 a {
            color: #444;
            font-size: 9px;
            text-decoration: none;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            transition: color 150ms ease-in-out;
            outline: none;
        }

        .row-2 a:hover {
            color: #888;
        }

        /* SETTINGS VIEW */
        #settings-view {
            display: none;
            flex-direction: column;
            gap: 16px;
            opacity: 0;
            transition: opacity 200ms ease-in-out;
        }

        #settings-view.visible {
            display: flex;
            opacity: 1;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 12px;
            border-bottom: 1px solid #111;
        }

        .settings-title {
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.5px;
            color: #888;
        }

        .back-link {
            color: #444;
            font-size: 9px;
            text-decoration: none;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            transition: color 150ms ease-in-out;
            outline: none;
        }

        .back-link:hover {
            color: #888;
        }

        .settings-content {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        input {
            background: transparent;
            border: none;
            border-bottom: 1px solid #222;
            color: #fff;
            padding: 8px 0;
            width: 100%;
            font-size: 10px;
            outline: none;
            font-family: inherit;
            transition: border-color 150ms ease-in-out;
        }

        input::placeholder {
            color: #333;
        }

        input:focus {
            border-bottom-color: #444;
        }

        .save-btn {
            width: 100%;
            background: #fff;
            color: #000;
            border: none;
            padding: 10px;
            font-size: 9px;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-family: inherit;
            transition: all 150ms ease-in-out;
            margin-top: 8px;
            border-radius: 16px;
        }

        .save-btn:hover {
            background: #ddd;
        }

        .toggle-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }

        .toggle-row span {
            font-size: 10px;
            color: #888;
        }

        .switch {
            position: relative;
            width: 36px;
            height: 20px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #333;
            transition: 0.2s;
            border-radius: 20px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: #666;
            transition: 0.2s;
            border-radius: 50%;
        }

        .switch input:checked + .slider {
            background-color: #fff;
        }

        .switch input:checked + .slider:before {
            transform: translateX(16px);
            background-color: #000;
        }

        /* MODAL */
        #modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 16px;
            z-index: 100;
        }

        .modal-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        #modal .modal-text {
            font-size: 9px;
            color: #888;
            letter-spacing: 0.5px;
        }

        #modal button {
            background: #fff;
            color: #000;
            border: none;
            padding: 6px 16px;
            font-size: 9px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 16px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-family: inherit;
            outline: none;
            transition: all 150ms ease-in-out;
        }
    </style>
</head>

<body>
    <!-- MAIN VIEW -->
    <div id="main-view" style="display: flex; flex-direction: column; justify-content: space-between; height: 100%;">
        <div class="row-1">
            <div class="branding">
                <div class="app-icon">â—†</div>
                <span class="app-name">POCKET</span>
            </div>
            <button id="power-btn" class="pill-toggle" onclick="toggle()">START</button>
        </div>

        <div class="row-2">
            <div class="row-2-left">
                <a href="#" onclick="window.electronAPI.send('QUIT'); return false;">Quit</a>
                <a href="#" onclick="showSettings(); return false;">Settings</a>
            </div>
            <div class="status-icons" id="status-icons">
                <button class="icon-btn lock muted" id="lock-btn" title="E2E Encrypted - Click to verify" onclick="toggleFingerprint()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                </button>
                <button class="icon-btn copy muted" id="copy-btn" title="Copy tunnel link" onclick="copyLink()">
                    <svg class="copy-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
                    <svg class="check-icon" style="display: none;" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                </button>
            </div>
        </div>

        <!-- Fingerprint reveal section -->
        <div id="fingerprint-section" style="display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid #222;">
            <div id="fingerprint-words" style="display: flex; flex-wrap: wrap; gap: 4px;"></div>
        </div>
    </div>

    <!-- SETTINGS VIEW -->
    <div id="settings-view">
        <div class="settings-header">
            <span class="settings-title">SETTINGS</span>
            <a href="#" class="back-link" onclick="hideSettings(); return false;">Back</a>
        </div>
        <div class="settings-content">
            <!-- Subdomain customization -->
            <div style="margin-bottom: 8px;">
                <div style="font-size: 9px; color: #555; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">Your Tunnel Address</div>
                <div style="display: flex; align-items: center; gap: 4px;">
                    <input type="text" id="subdomain-input" placeholder="your-name" style="flex: 1; text-align: right;">
                    <span style="font-size: 10px; color: #555;">.v0x.one</span>
                </div>
                <button onclick="changeSubdomain()" class="save-btn" style="margin-top: 8px;" id="subdomain-btn">Update Address</button>
                <div id="subdomain-status" style="font-size: 9px; color: #555; margin-top: 4px; text-align: center;"></div>
            </div>

            <div style="border-top: 1px solid #222; padding-top: 12px; margin-top: 4px;">
                <div style="font-size: 9px; color: #555; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Legacy Settings</div>
                <input type="password" id="cf-token" placeholder="Cloudflare Token (optional)">
                <input type="text" id="cf-domain" placeholder="Custom Domain (optional)">
            </div>

            <div class="toggle-row">
                <span>Debug Logging</span>
                <label class="switch">
                    <input type="checkbox" id="debug-logging">
                    <span class="slider"></span>
                </label>
            </div>
            <button onclick="saveSettings()" class="save-btn">Save Changes</button>
        </div>
    </div>


    <!-- Auth Modal -->
    <div id="modal">
        <div class="modal-content">
            <span class="modal-text" id="kid-display"></span>
            <button onclick="approve()">ALLOW</button>
        </div>
    </div>


    <script>
        // Use secure electronAPI from preload script (no direct Node access)
        const api = window.electronAPI;

        // Lucide icon SVGs
        const ICONS = {
            loader: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v4"/><path d="m16.2 7.8 2.9-2.9"/><path d="M18 12h4"/><path d="m16.2 16.2 2.9 2.9"/><path d="M12 18v4"/><path d="m4.9 19.1 2.9-2.9"/><path d="M2 12h4"/><path d="m4.9 4.9 2.9 2.9"/></svg>',
            square: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="none"><rect x="4" y="4" width="16" height="16" rx="2"/></svg>'
        };

        let active = false;
        let connecting = false;
        let currentUrl = "";
        let currentFingerprint = null;
        const btn = document.getElementById('power-btn');
        const modal = document.getElementById('modal');
        const kidDisplay = document.getElementById('kid-display');
        let pendingAuth = null;

        // Load settings - token from secure storage, domain from regular store
        async function loadSettings() {
            const [token, settings] = await Promise.all([
                api.invoke('GET_SECURE_TOKEN'),
                api.invoke('GET_STORE', 'cfSettings')
            ]);
            document.getElementById('cf-token').value = token || '';
            document.getElementById('cf-domain').value = (settings && settings.domain) || '';
            document.getElementById('debug-logging').checked = (settings && settings.debugLogging) || false;
        }
        loadSettings();

        async function showSettings() {
            const mainView = document.getElementById('main-view');
            const settingsView = document.getElementById('settings-view');

            mainView.style.display = 'none';
            settingsView.style.display = 'flex';

            // Expand window for larger settings view
            await api.invoke('RESIZE_WINDOW', 320);

            // Load current subdomain
            const subdomain = await api.invoke('GET_SUBDOMAIN');
            if (subdomain) {
                document.getElementById('subdomain-input').value = subdomain;
            }

            // Show settings with fade
            settingsView.classList.add('visible');
        }

        async function hideSettings() {
            const settingsView = document.getElementById('settings-view');
            const mainView = document.getElementById('main-view');

            // Fade out
            settingsView.classList.remove('visible');

            // Wait for fade, then switch views
            setTimeout(async () => {
                settingsView.style.display = 'none';
                mainView.style.display = 'flex';
                await api.invoke('RESIZE_WINDOW', 80);
            }, 200);
        }

        async function saveSettings() {
            const token = document.getElementById('cf-token').value;
            const domain = document.getElementById('cf-domain').value;
            const debugLogging = document.getElementById('debug-logging').checked;

            // Store token securely in OS keychain
            await api.invoke('SET_SECURE_TOKEN', token);

            // Store non-sensitive settings in regular store
            await api.invoke('SET_STORE', 'cfSettings', { domain, debugLogging });

            hideSettings();
        }

        async function changeSubdomain() {
            const input = document.getElementById('subdomain-input');
            const btn = document.getElementById('subdomain-btn');
            const status = document.getElementById('subdomain-status');
            const newSubdomain = input.value.trim().toLowerCase();

            // Validate format: alphanumeric + hyphens, 3-32 chars
            const validPattern = /^[a-z0-9][a-z0-9-]{1,30}[a-z0-9]$/;
            if (!newSubdomain || newSubdomain.length < 3) {
                status.style.color = '#ef4444';
                status.textContent = 'Subdomain must be at least 3 characters';
                return;
            }
            if (!validPattern.test(newSubdomain)) {
                status.style.color = '#ef4444';
                status.textContent = 'Use letters, numbers, and hyphens only';
                return;
            }

            // Show loading state
            btn.disabled = true;
            btn.textContent = 'Updating...';
            status.style.color = '#555';
            status.textContent = '';

            try {
                const result = await api.invoke('CUSTOMIZE_SUBDOMAIN', newSubdomain);
                if (result.success) {
                    status.style.color = '#22c55e';
                    status.textContent = 'Address updated successfully!';
                    // Update current URL in main view if active
                    if (currentUrl) {
                        currentUrl = `https://${result.hostname}`;
                    }
                } else {
                    status.style.color = '#ef4444';
                    status.textContent = result.error || 'Failed to update address';
                }
            } catch (e) {
                status.style.color = '#ef4444';
                status.textContent = e.message || 'Failed to update address';
            }

            btn.disabled = false;
            btn.textContent = 'Update Address';
        }

        function updateButtonState(state) {
            btn.classList.remove('active', 'connecting');
            btn.innerHTML = '';

            if (state === 'idle') {
                btn.innerText = 'START';
            } else if (state === 'connecting') {
                btn.classList.add('connecting');
                btn.innerHTML = 'CONNECTING <span class="icon spinning">' + ICONS.loader + '</span>';
            } else if (state === 'connected') {
                btn.classList.add('active');
                btn.innerHTML = 'CONNECTED <span class="icon">' + ICONS.square + '</span>';
            }
        }

        async function toggle() {
            if (!active && !connecting) {
                connecting = true;
                updateButtonState('connecting');

                // Get token from secure storage, domain from regular store
                const [token, settings] = await Promise.all([
                    api.invoke('GET_SECURE_TOKEN'),
                    api.invoke('GET_STORE', 'cfSettings')
                ]);

                const cfSettings = {
                    token: token || '',
                    domain: (settings && settings.domain) || ''
                };

                api.invoke('START', cfSettings).then(async res => {
                    if (res.success) {
                        // Stay in "connecting" state until TUNNEL_LIVE event
                        active = true;
                    } else {
                        connecting = false;
                        updateButtonState('idle');
                    }
                });
            } else if (active) {
                await api.invoke('STOP');
                active = false;
                connecting = false;
                currentFingerprint = null;
                currentUrl = '';
                fingerprintVisible = false;
                updateButtonState('idle');
                document.getElementById('copy-btn').classList.add('muted');
                document.getElementById('lock-btn').classList.add('muted');
                document.getElementById('fingerprint-section').style.display = 'none';
                await api.invoke('RESIZE_WINDOW', 80);

                // Update tray icon to idle state
                await api.invoke('SET_TRAY_ICON', false);
            }
        }

        api.on('TUNNEL_LIVE', async (url) => {
            currentUrl = url;

            // Tunnel is now live - transition from "connecting" to "connected"
            if (connecting) {
                connecting = false;
                updateButtonState('connected');
                await api.invoke('SET_TRAY_ICON', true);
            }

            // Activate copy icon
            document.getElementById('copy-btn').classList.remove('muted');
        });

        api.on('E2E_FINGERPRINT', (fingerprint) => {
            currentFingerprint = fingerprint;
            // Activate lock icon
            document.getElementById('lock-btn').classList.remove('muted');
        });

        api.on('AUTH_FAILED', (data) => {
            pendingAuth = data;
            kidDisplay.innerText = "New device: " + data.kid.substring(0, 12) + "...";
            modal.style.display = 'flex';
        });

        function approve() {
            if (pendingAuth) {
                api.invoke('REGISTER_KEY', { kid: pendingAuth.kid, jwk: pendingAuth.jwk }).then(() => {
                    modal.style.display = 'none';
                    pendingAuth = null;
                });
            }
        }

        let fingerprintVisible = false;

        async function toggleFingerprint() {
            const lockBtn = document.getElementById('lock-btn');
            if (lockBtn.classList.contains('muted') || !currentFingerprint) return;

            const section = document.getElementById('fingerprint-section');

            if (fingerprintVisible) {
                // Hide
                section.style.display = 'none';
                await api.invoke('RESIZE_WINDOW', 80);
                fingerprintVisible = false;
            } else {
                // Show
                const words = currentFingerprint.split('-');
                const container = document.getElementById('fingerprint-words');

                // Find longest word for consistent sizing
                const longestWord = words.reduce((a, b) => a.length > b.length ? a : b);
                const pillWidth = longestWord.length * 6 + 28;

                container.innerHTML = words.map((word, i) =>
                    `<div style="background: #1c1c1e; padding: 3px 6px; border-radius: 4px; display: inline-flex; align-items: center; gap: 4px; min-width: ${pillWidth}px;">
                        <span style="font-size: 8px; color: #555;">${i + 1}.</span>
                        <span style="font-size: 9px; color: #fff;">${word}</span>
                    </div>`
                ).join('');

                section.style.display = 'block';
                await api.invoke('RESIZE_WINDOW', 180);
                fingerprintVisible = true;
            }
        }

        function copyLink() {
            const copyBtn = document.getElementById('copy-btn');
            if (copyBtn.classList.contains('muted') || !currentUrl) return;

            navigator.clipboard.writeText(currentUrl).then(() => {
                const copyIcon = copyBtn.querySelector('.copy-icon');
                const checkIcon = copyBtn.querySelector('.check-icon');

                copyIcon.style.display = 'none';
                checkIcon.style.display = 'block';

                setTimeout(() => {
                    checkIcon.style.display = 'none';
                    copyIcon.style.display = 'block';
                }, 2000);
            });
        }

        // Sync state on window show (in case connection state changed while hidden)
        api.on('SYNC_STATE', (state) => {
            active = state.active;
            connecting = false;
            currentUrl = state.url || '';
            currentFingerprint = state.fingerprint || null;

            // Reset fingerprint section
            fingerprintVisible = false;
            document.getElementById('fingerprint-section').style.display = 'none';

            const copyBtn = document.getElementById('copy-btn');
            const lockBtn = document.getElementById('lock-btn');

            if (active) {
                updateButtonState('connected');
                // Toggle muted state based on available data
                copyBtn.classList.toggle('muted', !currentUrl);
                lockBtn.classList.toggle('muted', !currentFingerprint);
            } else {
                updateButtonState('idle');
                copyBtn.classList.add('muted');
                lockBtn.classList.add('muted');
            }
        });
    </script>
</body>

</html>